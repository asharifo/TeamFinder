services:
  edge-proxy:
    image: nginx:1.27-alpine
    container_name: edge-proxy
    ports:
      - "8080:80"
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - web
      - gateway
      - messaging-service
    restart: unless-stopped

  web:
    build: ./apps/web
    container_name: web
    restart: unless-stopped

  gateway:
    build: ./services/gateway
    container_name: gateway
    environment:
      - PORT=3000
      - AUTH0_ISSUER_BASE_URL=${AUTH0_ISSUER_BASE_URL:-}
      - AUTH0_AUDIENCE=${AUTH0_AUDIENCE:-}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:8080}
      - UPSTREAM_TIMEOUT_MS=${UPSTREAM_TIMEOUT_MS:-10000}
      - AUTH_SERVICE_URL=http://auth-service:3001
      - PROFILE_SERVICE_URL=http://profile-service:3002
      - CLASS_SERVICE_URL=http://class-service:3003
      - MESSAGING_SERVICE_URL=http://messaging-service:3004
      - RECOMMENDATION_SERVICE_URL=http://recommendation-service:3005
      - LOG_LEVEL=info
    depends_on:
      - auth-service
      - profile-service
      - class-service
      - messaging-service
      - recommendation-service
    restart: unless-stopped

  auth-service:
    build: ./services/auth-service
    container_name: auth-service
    environment:
      - PORT=3001
      - DATABASE_URL=postgres://postgres:${POSTGRES_PASSWORD:?set POSTGRES_PASSWORD}@auth-db:5432/auth_db
      - AUTH0_DOMAIN=${AUTH0_DOMAIN:-}
      - AUTH0_ISSUER_BASE_URL=${AUTH0_ISSUER_BASE_URL:-}
      - AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID:-}
      - AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET:-}
      - AUTH0_AUDIENCE=${AUTH0_AUDIENCE:-}
      - AUTH0_REDIRECT_URI=${AUTH0_REDIRECT_URI:-http://localhost:8080/}
      - AUTH0_REQUEST_TIMEOUT_MS=${AUTH0_REQUEST_TIMEOUT_MS:-10000}
      - KAFKA_BROKER=kafka:9092
      - LOG_LEVEL=info
    depends_on:
      - auth-db
      - kafka
    restart: unless-stopped

  profile-service:
    build: ./services/profile-service
    container_name: profile-service
    environment:
      - PORT=3002
      - DATABASE_URL=postgres://postgres:${POSTGRES_PASSWORD:?set POSTGRES_PASSWORD}@profile-db:5432/profile_db
      - KAFKA_BROKER=kafka:9092
      - S3_ENDPOINT=http://minio:9000
      - S3_PUBLIC_ENDPOINT=${S3_PUBLIC_ENDPOINT:-http://localhost:9000}
      - S3_REGION=us-east-1
      - S3_ACCESS_KEY=${S3_ACCESS_KEY:?set S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY:?set S3_SECRET_KEY}
      - S3_BUCKET=teamfinder-profile-images
      - LOG_LEVEL=info
    depends_on:
      - profile-db
      - kafka
      - minio
    restart: unless-stopped

  class-service:
    build: ./services/class-service
    container_name: class-service
    environment:
      - PORT=3003
      - DATABASE_URL=postgres://postgres:${POSTGRES_PASSWORD:?set POSTGRES_PASSWORD}@class-db:5432/class_db
      - KAFKA_BROKER=kafka:9092
      - INGEST_TOKEN=${INGEST_TOKEN:?set INGEST_TOKEN}
      - LOG_LEVEL=info
    depends_on:
      - class-db
      - kafka
    restart: unless-stopped

  messaging-service:
    build: ./services/messaging-service
    container_name: messaging-service
    environment:
      - PORT=3004
      - DATABASE_URL=postgres://postgres:${POSTGRES_PASSWORD:?set POSTGRES_PASSWORD}@messaging-db:5432/messaging_db
      - REDIS_URL=redis://redis:6379
      - KAFKA_BROKER=kafka:9092
      - AUTH0_ISSUER_BASE_URL=${AUTH0_ISSUER_BASE_URL:-}
      - AUTH0_AUDIENCE=${AUTH0_AUDIENCE:-}
      - LOG_LEVEL=info
    depends_on:
      - messaging-db
      - redis
      - kafka
    restart: unless-stopped

  recommendation-service:
    build: ./services/recommendation-service
    container_name: recommendation-service
    environment:
      - PORT=3005
      - DATABASE_URL=postgres://postgres:${POSTGRES_PASSWORD:?set POSTGRES_PASSWORD}@recommendation-db:5432/recommendation_db
      - KAFKA_BROKER=kafka:9092
      - LOG_LEVEL=info
    depends_on:
      - recommendation-db
      - kafka
    restart: unless-stopped

  auth-db:
    image: postgres:16-alpine
    container_name: auth-db
    environment:
      - POSTGRES_DB=auth_db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?set POSTGRES_PASSWORD}
    volumes:
      - auth-db-data:/var/lib/postgresql/data
      - ./infra/postgres/auth/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: unless-stopped

  profile-db:
    image: postgres:16-alpine
    container_name: profile-db
    environment:
      - POSTGRES_DB=profile_db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?set POSTGRES_PASSWORD}
    volumes:
      - profile-db-data:/var/lib/postgresql/data
      - ./infra/postgres/profile/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: unless-stopped

  class-db:
    image: postgres:16-alpine
    container_name: class-db
    environment:
      - POSTGRES_DB=class_db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?set POSTGRES_PASSWORD}
    volumes:
      - class-db-data:/var/lib/postgresql/data
      - ./infra/postgres/class/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: unless-stopped

  messaging-db:
    image: postgres:16-alpine
    container_name: messaging-db
    environment:
      - POSTGRES_DB=messaging_db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?set POSTGRES_PASSWORD}
    volumes:
      - messaging-db-data:/var/lib/postgresql/data
      - ./infra/postgres/messaging/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: unless-stopped

  recommendation-db:
    image: postgres:16-alpine
    container_name: recommendation-db
    environment:
      - POSTGRES_DB=recommendation_db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?set POSTGRES_PASSWORD}
    volumes:
      - recommendation-db-data:/var/lib/postgresql/data
      - ./infra/postgres/recommendation/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: redis
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
    restart: unless-stopped

  kafka:
    image: apache/kafka:3.7.2
    container_name: kafka
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - CLUSTER_ID=abcdefghijklmnopqrstuv
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
    volumes:
      - kafka-data:/tmp/kraft-combined-logs
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    container_name: minio
    command: ["server", "/data", "--console-address", ":9001"]
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:?set MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:?set MINIO_ROOT_PASSWORD}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    restart: unless-stopped

  minio-init:
    image: minio/mc:latest
    container_name: minio-init
    network_mode: "service:minio"
    depends_on:
      minio:
        condition: service_started
    environment:
      - MINIO_URL=http://127.0.0.1:9000
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:?set MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:?set MINIO_ROOT_PASSWORD}
      - MINIO_BUCKET=teamfinder-profile-images
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:8080,http://localhost:5173,http://127.0.0.1:5173}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY:-}
      - S3_SECRET_KEY=${S3_SECRET_KEY:-}
    volumes:
      - ./infra/minio/init.sh:/init.sh:ro
    entrypoint: ["/bin/sh", "/init.sh"]
    restart: "no"

  loki:
    image: grafana/loki:3.0.0
    container_name: loki
    command: ["-config.file=/etc/loki/loki-config.yaml"]
    volumes:
      - ./infra/loki/loki-config.yaml:/etc/loki/loki-config.yaml:ro
      - loki-data:/loki
    restart: unless-stopped

  vector:
    image: timberio/vector:0.38.0-alpine
    container_name: vector
    command: ["--config", "/etc/vector/vector.toml"]
    environment:
      - VECTOR_LOG=error
    volumes:
      - ./infra/vector/vector.toml:/etc/vector/vector.toml:ro
    depends_on:
      - loki
    restart: unless-stopped

  grafana:
    image: grafana/grafana-oss:11.0.0
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:?set GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:?set GRAFANA_ADMIN_PASSWORD}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./infra/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - loki
    restart: unless-stopped

volumes:
  auth-db-data:
  profile-db-data:
  class-db-data:
  messaging-db-data:
  recommendation-db-data:
  redis-data:
  kafka-data:
  loki-data:
  grafana-data:
  minio-data:
